name: Claude Code Review

on:
  # Trigger on PR comments mentioning @claude
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

  # Automatic review on PR events
  pull_request:
    types: [opened, synchronize]

  # Manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      review_type:
          description: 'Type of review to perform'
          required: true
          default: 'full'
          type: choice
          options:
              - full
              - security
              - performance
              - architecture

permissions:
      contents: read
      pull-requests: write
      issues: write

jobs:
  # Respond to @claude mentions in comments
  claude_mention:
      if: github.event_name == 'issue_comment' || github.event_name == 'pull_request_review_comment'
      runs-on: ubuntu-latest
      steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
                fetch-depth: 0

          - name: Claude Code Response
            uses: anthropics/claude-code-action@v1
            with:
                anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
                github_token: ${{ secrets.GITHUB_TOKEN }}
                claude_args: |
                  --max-turns 5
                  --model claude-sonnet-4-5-20250929

  # Automatic code review on PR open/update
  auto_review:
      if: github.event_name == 'pull_request'
      runs-on: ubuntu-latest
      steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
                fetch-depth: 0

          - name: Run Automated Quality Checks
            run: |
                echo "ðŸ“‹ Running quality checks..."
                # Note: These will be quick checks since we're in CI
                # Full checks run in the CI workflow

          - name: Claude Code Review
            uses: anthropics/claude-code-action@v1
            with:
                anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
                github_token: ${{ secrets.GITHUB_TOKEN }}
                prompt: |
                    /review

                    Please review this pull request with focus on:
                    1. Architectural alignment with DDD principles
                    2. Code quality and maintainability
                    3. Security best practices
                    4. Performance considerations
                    5. Test coverage
                    6. Documentation completeness

                    Provide specific, actionable feedback with code examples where relevant.
                    Follow the guidelines in CLAUDE.md for project-specific standards.
                claude_args: |
                  --max-turns 10
                  --model claude-sonnet-4-5-20250929

  # Manual review with specific focus
  manual_review:
      if: github.event_name == 'workflow_dispatch'
      runs-on: ubuntu-latest
      steps:
          - name: Checkout code
            uses: actions/checkout@v4
            with:
                fetch-depth: 0

          - name: Claude Code Review - ${{ github.event.inputs.review_type }}
            uses: anthropics/claude-code-action@v1
            with:
                anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
                github_token: ${{ secrets.GITHUB_TOKEN }}
                prompt: |
                    /review

                    Perform a ${{ github.event.inputs.review_type }} review of this codebase.
                    Follow the guidelines in CLAUDE.md and focus on ${{ github.event.inputs.review_type }} aspects.
                claude_args: |
                  --max-turns 10
                  --model claude-sonnet-4-5-20250929
