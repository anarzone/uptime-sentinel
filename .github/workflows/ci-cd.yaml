name: Uptime Sentinel CI

on:
    push:
        branches:
            - main
    pull_request:
        branches: [ "main" ]

permissions:
    contents: write # Required to create tags and releases
    issues: write
    pull-requests: write
    id-token: write # Required for OIDC token

jobs:
    quality:
        name: Code Quality Checks
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.4'
                    tools: composer:v2
                    coverage: none
                env:
                    update: true

            -   name: Install Dependencies
                run: composer install --no-progress --prefer-dist

            -   name: Check Code Style
                run: composer check-style

            -   name: Run Static Analysis
                run: vendor/bin/phpstan analyse src --memory-limit=1G

    tests:
        needs: quality
        runs-on: ubuntu-latest

        services:
            mysql:
                image: mysql:8.0
                env:
                    MYSQL_ROOT_PASSWORD: root
                    MYSQL_DATABASE: uptime_sentinel_test
                ports:
                    - 3306:3306
                options: >-
                    --health-cmd="mysqladmin ping --silent"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=3
            redis:
                image: redis:7
                ports:
                    - 6379:6379
                options: >-
                    --health-cmd="redis-cli ping"
                    --health-interval=10s
                    --health-timeout=5s
                    --health-retries=5

        env:
            DATABASE_URL: mysql://root:root@127.0.0.1:3306/uptime_sentinel
            REDIS_URL: redis://127.0.0.1:6379

        steps:
            -   name: Checkout code
                uses: actions/checkout@v4

            -   name: Setup PHP
                uses: shivammathur/setup-php@v2
                with:
                    php-version: '8.4'
                    extensions: pdo, pdo_mysql, redis
                env:
                    update: true

            -   name: Install Dependencies
                run: composer install --no-progress --prefer-dist

            -   name: Run Database Migrations
                run: php bin/console doctrine:migrations:migrate --no-interaction --env=test

            -   name: Run Tests
                run: vendor/bin/phpunit

    release:
        name: Automate Versioning
        needs: [ quality, tests ]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            -   name: Checkout Code
                uses: actions/checkout@v4
                with:
                    fetch-depth: 0 # Important: Fetch all history for history analysis

            -   name: Setup Node.js
                uses: actions/setup-node@v4
                with:
                    node-version: "lts/*"

            -   name: Run Semantic Release
                uses: cycjimmy/semantic-release-action@v4
                env:
                    GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                with:
                    extra_plugins: |
                        @semantic-release/changelog
                        @semantic-release/git
                        conventional-changelog-conventionalcommits

    build-app:
        name: Build App (ARM64)
        needs: [ quality, tests ]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            -   name: Checkout Code
                uses: actions/checkout@v4

            -   name: Set up QEMU
                uses: docker/setup-qemu-action@v2

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v2

            -   name: Log in to GitHub Container Registry
                uses: docker/login-action@v2
                with:
                    registry: ghcr.io
                    username: ${{ github.actor }}
                    password: ${{ secrets.GITHUB_TOKEN }}

            -   name: Build and push App image
                uses: docker/build-push-action@v4
                with:
                    context: .
                    file: Dockerfile
                    platforms: linux/arm64
                    push: true
                    tags: ghcr.io/${{ github.repository }}/app:latest
                    cache-from: type=gha
                    cache-to: type=gha,mode=max

    build-nginx:
        name: Build Nginx (ARM64)
        needs: [ quality, tests ]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        permissions:
            contents: read
            packages: write
        steps:
            -   name: Checkout Code
                uses: actions/checkout@v4

            -   name: Set up Docker Buildx
                uses: docker/setup-buildx-action@v2

            -   name: Log in to GitHub Container Registry
                uses: docker/login-action@v2
                with:
                    registry: ghcr.io
                    username: ${{ github.actor }}
                    password: ${{ secrets.GITHUB_TOKEN }}

            -   name: Build and push Nginx image
                uses: docker/build-push-action@v4
                with:
                    context: .
                    file: docker/nginx/Dockerfile
                    # Nginx is just a config file, native build is enough for the generic image
                    platforms: linux/amd64,linux/arm64
                    push: true
                    tags: ghcr.io/${{ github.repository }}/nginx:latest
                    cache-from: type=gha
                    cache-to: type=gha,mode=max

    deploy:
        name: Deploy to Production (Coolify)
        needs: [ build-app, build-nginx ]
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        runs-on: ubuntu-latest
        steps:
            -   name: Trigger Coolify Deployment
                env:
                    COOLIFY_URL: ${{ secrets.COOLIFY_URL }}
                    COOLIFY_TOKEN: ${{ secrets.COOLIFY_TOKEN }}
                    COOLIFY_APP_UUID: ${{ secrets.COOLIFY_APP_UUID }}
                    CF_ACCESS_CLIENT_ID: ${{ secrets.CF_ACCESS_CLIENT_ID }}
                    CF_ACCESS_CLIENT_SECRET: ${{ secrets.CF_ACCESS_SERVICE_TOKEN }}
                run: |
                    curl --request POST \
                      --header "Authorization: Bearer $COOLIFY_TOKEN" \
                      --header "CF-Access-Client-Id: $CF_ACCESS_CLIENT_ID" \
                      --header "CF-Access-Client-Secret: $CF_ACCESS_CLIENT_SECRET" \
                      --header "Content-Type: application/json" \
                      --data "{\"uuid\": \"$COOLIFY_APP_UUID\", \"force\": true}" \
                      --retry 3 \
                      --retry-delay 5 \
                      --silent --show-error \
                      "$COOLIFY_URL/api/v1/deploy"
